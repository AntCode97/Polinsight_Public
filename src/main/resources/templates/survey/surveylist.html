<th:block>
  <div class="main_survey_list_wrap">
    <div class="main_survey_list_title">
      <p>진행중인 <span class="pol_color">온라인조사</span></p>
      <span>폴인사이트에서 현재 진행중인 온라인조사를 소개해드립니다.</span>
    </div>
    <div class="main_survey_box">
    </div>
  </div>
  <script th:inline="javascript">

    const makeSurveyCard = survey => {
      let template = $(`<div></div>`).addClass('main_survey_item')
      if (survey.status.progress === 'ONGOING') {
        template.addClass('bg_color_item_white')
        template.append(`<p class="survey_run">진행중</p>`)
        template.on('mouseover', function () {
          $(this).css('cursor', 'pointer').css('box-shadow', '5px 5px 10px rgba(0,0,0, .3)').css('transition', 'box-shadow 0.5s ease-in-out')
        }).on('mouseleave', function () {
          $(this).css('cursor', 'default').css('box-shadow', 'none')
        }).on('click', {seq: survey.id, surveyid: survey.surveyId, title: survey.title}, surveyCardClickEventHandler)

      } else {
        template.addClass('bg_color_item_gray')
        template.append(`<p class="survey_stop">조사완료</p>`)
        template.on('click', function () {
          alert('종료된 설문입니다.')
        })
      }
      template.append(`<p class="survey_title">${survey.title}</p>`)
      template.append(`<p class="survey_point"> ${!survey.point ? '지정 안됨' : survey.point + ' P'}</p>`)
      template.append(`<p class="survey_date"> ${!survey.endAt ? '지정 안됨' : '~ ' + survey.endAt.split('T')[0]}</p>`)

      return template;
    }
    const makeSurveyCardList = (surveyList) => {

      const survey_box = $(".main_survey_box");
      let item_wrap = survey_box.find(".main_survey_item_wrap:last-child")
      let count = 0;
      surveyList.forEach(survey => {
        if (count % 3 !== 0) {
          item_wrap.append(makeSurveyCard(survey))
        } else {
          survey_box.append('<div class="main_survey_item_wrap"></div>')
          item_wrap = survey_box.find(".main_survey_item_wrap:last-child")
          item_wrap.append(makeSurveyCard(survey))
        }
        count++;
      })
    }

    const getSurveyList = () => {
      axios.get('/api/surveys?type=index')
          .then(res => {
            console.log(res)
            if (res.data.success) {
              makeSurveyCardList(res.data.response)
            }
          })
          .catch(err => console.log(err))
    }


    const asyncSurveySearch = () => {
      // 서베이 요소 비우기
      const survey_box = $('.main_survey_box')
      const input = $('input[name=searchInput]')
      survey_box.empty()
      // 검색 타입 가져오기
      const searchType = $('.survey_search_option').val()
      if (!input) {
        // 아무것도 입력이 없을 때
        makeSurveyCardList(surveys)
      } else {
        const filteredSurveys = surveys.filter(s => {
          if (searchType === 'title') {
            return s.title.match(input.val())
          } else if (searchType === 'point') {
            return s.point >= (input.val() * 1)
          } else if (searchType === 'end_date') {
          }
        })

        makeSurveyCardList(filteredSurveys)
      }
    }

    const loginChk = () => {
      /*<![CDATA[*/
      let sessionUser = /*[[${session.user}]]*/;
      /*]]*/
      if (!sessionUser) {
        alert('로그인을 먼저 해주세요')
        return false
      }
      return true
    }

    const surveyCardClickEventHandler = (e) => {
      if (!loginChk()) return
      e.preventDefault()
      e.returnValue = false;

      const seq = e.data.seq
      const surveyId = e.data.surveyid
      const title = e.data.title

      if (confirm(title + ' 설문을 진행하시겠습니까?')) {
// 서버에 서베이 정보 + 유저 정보 저장 ==> 이후 관리자 및 마이페이지에서 목록 조회 가능
//         let dynamicNewForm = $(`<form action="/survey/${surveyId}" method="post"></form>`)
//           dynamicNewForm.appendTo('body');
//           dynamicNewForm.submit();
      }
    }

    $(function () {
      getSurveyList();
      $('input[name=searchInput]').on('change', asyncSurveySearch)
    })
  </script>
</th:block>