<!DOCTYPE html>
<html lang="en">
<head>
    <title>폴인사이트</title>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link crossorigin="anonymous" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
          integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf"
          rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <style>
        .login_input {
            width: 100%;
            outline: none;
            border: none;
            border-bottom: 1.5px solid #dde0ea;
            color: #343236;
            padding: 8px 0px;
            height: 43px;
            font-size: 16px;
        }

        .login_btn_wrap > .btn-primary {
            width: 100%;
            font-weight: bold;
            float: left;
        }

        .btn-effect {
            padding: 12px;
            font-size: 18px;
            text-align: center;
            border-radius: 2px;
            cursor: pointer;
            border: 1px solid transparent;
            outline: none;
        }

        .login_content {
            width: 25rem;
            margin: 0 auto;
            text-align: center;
        }

        .modal_content {
            width: 50%;
            background-color: white;
            border-radius: 2px;
            overflow: hidden;
            margin: 0 auto;
        }

        .modal_wrap {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input_div {
            width: 100%;
            overflow: hidden;
            position: relative;
            margin-bottom: 20px;
        }

        .input_div > label > p {
            font-size: 16px;
            text-align: left;
            color: #a5dff9;
        }

        .invalid {
            color: #FF0000;
        }

        .vaild {
            color: #00CC00;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div class="modal_wrap">
    <div class="modal_content">
        <fieldset>
            <legend>회원 가입</legend>
            <div class="login_content">
                <form action="/signup" id="signupfrm" method="post">
                    <div class="input_div">
                        <label for="email">
                            <p><i class="far fa-envelope"></i>&nbsp;이메일</p>
                        </label>
                        <input class="login_input" id="email" name="email" type="text" required placeholder="이메일" style="display: inline;"/>
                        @
                        <select id="email_domain" style="display: inline;">
                            <option>-- 선택 --</option>
                            <option value="naver.com">naver.com</option>
                            <option value="gmail.com">gmail.com</option>
                            <option value="kakao.com">kakao.com</option>
                        </select>
                        <span id="emailmsg"></span>
                    </div>
                    <div class="input_div">
                        <label for="password">
                            <p><i class="fas fa-lock"></i>&nbsp;패스워드</p>
                        </label>
                        <input class="pwinput login_input" id="password" name="password" type="password" required placeholder="패스워드"/>
                        <span>영문 대소문자/숫자/특수문자 중 2가지 이상 조합, 10자~16자</span>
                    </div>
                    <div class="input_div">
                        <label for="pwconfirm">
                            <p><i class="fas fa-lock"></i>&nbsp;패스워드 확인</p>
                        </label>
                        <input class="pwinput login_input" id="pwconfirm" type="password" required placeholder="패스워드 확인"/>
                        <span class="err_msg" id="pwmsg"></span>
                    </div>
                    <div class="input_div">
                        <label for="inputname">
                            <p><i class="fas fa-user"></i>이름</p>
                        </label>
                        <input class="login_input" id="inputname" name="name" type="text" required placeholder="이름"/>
                    </div>
                    <div>
                        휴대전화
                        <input id="phone" type="tel" placeholder="휴대전화">
                        <span>'-' 없이 입력해주세요.</span>
                        <button>인증</button>
                    </div>
                    <div>
                        추천인 휴대전화
                        <input id="phone_rec_user" type="number" placeholder="추천인 휴대전화">
                        <button>확인</button>
                    </div>
                    <div class="hidden">
                        <input type="text" value="일반">
                    </div>
                    <div class="login_btn_wrap">

                        <button class="btn-primary btn-effect" onclick="window.history.back()"><p>돌아가기<i class="fas fa-arrow-left"></i></p></button>
                    </div>


                </form>
            </div>
        </fieldset>
        <div>
            <div>
                <p>폴인사이트의 패널이 된다면?</p>
                <p>
                    폴인사이트에서 진행하는 각종 조사에 참여하실 수 있습니다.
                    참여한 조사에 따라 포인트를 현금으로 지급받으실 수 있습니다.
                    폴's 인사이트 게시판을 통해 조사 주요 결과를 확인하실 수 있습니다.
                    패널로 가입하시겠습니까?
                </p>
            </div>
            <div>
                <input name="is_panel" value="panel_signup" style="display: inline" type="radio">가입하고 혜택받기<br>
                <input name="is_panel" value="normal_signup" style="display: inline" type="radio">일반 회원으로 계속<br>
            </div>
            <div class="login_btn_wrap">
                <button class="btn-primary btn-effect" id="frmsubmit">회원 가입<i class="fas fa-sign-in-alt"></i></button>
            </div>
        </div>
    </div>
</div>

<!--Validation Library-->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script>
  const editHyphen = phone => {
    const inHyphen = "//([0-9]{2,3})-([0-9]{3,4})-([0-9]{4})//";
    if (phone.match(inHyphen)) {
      return phone.replace(/([0-9]{2,3})-([0-9]{3,4})-([0-9]{4})/, "$1$2$3")
    } else {
      return phone.replace(/(^02.{0}|^01.{1}|[0-9]{3})([0-9]+)([0-9]{4})/, "$1-$2-$3")
    }
  }

  // 비밀번호 확인 검증
  const passwordChecker = () => {
    const passwordValue = $("#password").val();
    const confirmValue = $("#pwconfirm").val();
    const msg = $("#pwmsg")


    if (passwordValue === confirmValue) {
      // 공백 제거
      if (confirmValue.replace(/\s/g, "").length >= 8 && passwordValue.replace(/\s/g, "").length >= 8) {
        msg.text("사용 가능한 패스워드 입니다.").removeClass("invalid").addClass("valid")
        return
      }
    }
    msg.text("올바른 패스워드를 입력해주세요.").removeClass("valid").addClass("invalid")
  }

  // 필수 입력값 검사
  const checkNotNull = () => {
    let result = true
    $("#signupfrm").find('input').each(function (item) {
      let input = $(this)
      let label = input.prev()
      let inputValue = input.val()
      if ($(this).prop('required') && (inputValue == null || inputValue === "" || inputValue === undefined || inputValue === "undefined")) {
        input.focus()    // 입력이 안된 사항으로 포커싱
        input.val('') // 값 초기화
        alert(label.text().trim() + " 항목은 필수 입력 사항입니다.")
        result = false
        return false;   // $.each를 break
      }
    })

    return result;
  }


  const debounceCallEmailCheck = _.debounce(email => {
    axios.get("http://localhost:8080/user/" + email)
        .then(res => {
          if (res.data === "" || res.data === null || res.data === undefined || res.data === "undefined") {
            // 응답 data가 비어있으면 아이디가 없는 것 ==> 사용 가능한 이메일

          }
        })
        .catch(err => {
          console.log("error")
          console.log(err)
        })
  }, 200)

  const emailChecker = () => {
    const regex = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i;
    const emailValue = $("#email").val();
    const msg = $("#emailmsg")

    if (emailValue === "") {
      msg.text("").removeClass("valid").addClass("invalid")
    } else {
      if (emailValue.match(regex) != null) {
        msg.text("사용 가능한 이메일입니다.").removeClass("invalid").addClass("valid")
        debounceCallEmailCheck(emailValue);
      } else {
        msg.text("올바른 이메일을 입력해주세요").removeClass("valid").addClass("invalid")
      }

    }
  }

  $(window).ready(() => {

    $(document).on('focus', '.login_input', function () {
      $(this).css('border-bottom', '1.5px solid #4C99CF');
    });

    $(document).on('blur', '.login_input', function () {
      $(this).css('border-bottom', '1.5px solid #dde0ea');
    });
  })

  $(document).ready(() => {
    $(".pwinput").on("change keydown keyup paste", passwordChecker);

    $("#email").on("change keydown keyup paste", emailChecker);

    $("#phone").on("blur", editHyphen);

    $("#frmsubmit").on('click', function (e) {
      e.preventDefault()
      e.stopPropagation()
      // 필수 값이 모두 채워져 있는지 확인
      if (checkNotNull()) {
        if ($("input[name='is_panel']:checked").val() === 'panel_signup') {
// 패널 정보 추가 페이지로, 정보는 서버로 보내고 sendRedirect로 추가 정보 받기

        } else {
          $(this).submit()

        }
      }
    })
  })

</script>
</body>
</html>