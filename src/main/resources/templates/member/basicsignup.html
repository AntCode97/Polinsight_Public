<th:block th:include="layout/header" />
<th:block>
  <style>
    .header_wrap {
      background-color : rgb(24, 40, 56) !important;
    }

    .err_msg {
      display : none;
    }

    .register_wrap {
      margin     : 0 auto;
      margin-top : 120px;
      /*top: 80px;*/
      position   : relative;
      width      : 1000px;
    }

    .register_title {
      color         : black;
      margin-bottom : 20px;
    }

    .register_title > h1 {
      font-size   : 25px;
      font-weight : bold;
      text-align  : center;
    }

    .register_contents_wrap > form > p {
      color         : black;
      font-size     : 18px;
      font-weight   : bold;
      margin-bottom : 8px;
    }

    .register_contents {
      border-top : 1px solid #DDDDDD;
    }

    .register_contents > ul > li {
      align-items   : center;
      border-bottom : 1px solid #DDDDDD;
      display       : flex;
      font-size     : 14px;
      padding       : 10px 0;
    }

    .left_content {
      flex : 1.5;
    }

    .right_content {
      flex : 8.5;
    }

    .left_content > label {
      background  : url('img/etc/icon_required_input.png') right center no-repeat;
      font-weight : bold;
      line-height : 18px;
      overflow    : hidden;
      padding     : 0 15px;
    }

    .right_content > input {
      border      : 1px solid #DDDDDD;
      color       : #333333;
      font-size   : 14px;
      height      : 32px;
      line-height : 32px;
      margin      : 0 3px;
      outline     : none;
      width       : 300px;
    }

    .right_content > select {
      border          : 1px solid #DDDDDD;
      color           : #333333;
      display         : inline-block;
      font-size       : 14px;
      height          : 32px;
      line-height     : 32px;
      margin          : 0 3px;
      outline         : none;
      text-align      : center;
      text-align-last : center;
      width           : 200px;
    }

    .info_msg, .err_msg {
      font-size   : 12px;
      font-weight : normal;
      padding     : 0 5px;
    }

    .info_msg {
      color : #A9A9A9;
    }

    .err_msg {
      color : red;
    }

    .correct_msg {
      color   : greenyellow;
      display : inline-block;
    }

    .no_need {
      background-image : url('') !important;
    }

    .pannel_info_contents {
      background-color : #EEEEEE;
      border-radius    : 20px;
      margin           : 40px auto 30px;
      padding          : 15px 0;
      width            : 800px;
    }

    .pannel_info_contents > * {
      color         : black;
      margin-bottom : 15px;
      text-align    : center;
    }

    .pannel_info_contents > h1 {
      font-size : 22px;
    }

    .pannel_info_contents > p {
      font-size   : 16px;
      font-weight : normal;
    }

    .pannel_select {
      align-items     : center;
      display         : flex;
      justify-content : space-between;
      margin          : 0 auto;
      width           : 300px;
    }

    .radio_wrap > label {
      color       : black;
      cursor      : pointer;
      font-size   : 16px;
      font-weight : bold;
    }

    .btn_wrap {
      align-items     : center;
      display         : flex;
      justify-content : center;
      margin-top      : 30px;
    }

    .btn_submit {
      background-color : #192739;
      border           : none;
      color            : white;
      cursor           : pointer;
      font-size        : 16px;
      font-weight      : bold;
      outline          : none;
      padding          : 7px 45px;
    }

    .popup_overlay {
      background-color : rgba(0, 0, 0, 0.4);
      display          : none;
      height           : 100vh;
      left             : 50%;
      position         : fixed;
      top              : 50%;
      transform        : translate(-50%, -50%);
      width            : 100%;
    }

    .popup_box {
      background-color : white;
      box-shadow       : 2px 5px 10px 0px rgba(0, 0, 0, 0.35);
      left             : 50%;
      position         : relative;
      top              : 50%;
      transform        : translate(-50%, -50%);
      width            : 550px;
    }

    .popup_box .popup_content {
      color      : #666666;
      font-size  : 14px;
      padding    : 50px;
      word-break : break-word;
    }

    .popup_content > h3 {
      text-align : center;
    }

    .popup_btn_wrap {
      align-items     : center;
      display         : flex;
      justify-content : center;
      padding-bottom  : 25px;
    }

    .popup_box .popup_btn {
      background : #192739;
      border     : none;
      color      : white;
      outline    : none;
      padding    : 10px 25px;
      text-align : center;
    }

    .popup_btn:hover {
      cursor : pointer;
    }
  </style>
  <div class="flex-wrapper">
    <div class="flex-content">

      <div class="register_wrap">
        <div class="register_box">
          <div class="register_title">
            <h1>회원 가입</h1>
          </div>
          <div class="register_contents_wrap">
            <form th:action="@{/signup}" id="signupfrm" method="post">
              <p>기본정보</p>
              <div class="register_contents">
                <ul>
                  <li>
                    <div class="left_content">
                      <label for="email">
                        아이디(이메일)
                      </label>
                    </div>
                    <div class="right_content">
                      <input id="email" name="email" required type="text" maxlength="20" minlength="5" />
                      <span>@</span>
                      <select name="domain" id="email_domain" required>
                        <option value="naver.com">naver.com</option>
                        <option value="gmail.com">gmail.com</option>
                        <option value="kakao.com">kakao.com</option>
                      </select>
                      <span id="email_msg"></span>
                      <!--                <span class="info_msg"></span>-->
                    </div>
                  </li>
                  <li>
                    <div class="left_content">
                      <label for="password">
                        비밀번호
                      </label>
                    </div>
                    <div class="right_content">
                      <input class="pwdinput" id="password" name="password" required type="password" minlength="10" maxlength="16" />
                      <span class="err_msg">올바른 비밀번호를 입력하세요.</span>
                      <span class="info_msg">영문 대소문자/숫자/특수문자 중 2가지 이상 조합, 10자~16자</span>
                    </div>
                  </li>
                  <li>
                    <div class="left_content">
                      <label for="pwdconfirm">
                        비밀번호 확인
                      </label>
                    </div>
                    <div class="right_content">
                      <input class="pwdinput" name="confirm" id="pwdconfirm" required type="password" minlength="10" maxlength="16" />
                      <span class="err_msg">비밀번호가 일치하지 않습니다.</span>
                      <span class="info_msg" id="pwmsg"></span>
                    </div>
                  </li>
                  <li>
                    <!--TODO : 특수문자 검증 필요-->
                    <div class="left_content">
                      <label for="user_name">이름</label>
                    </div>
                    <div class="right_content">
                      <input class="login_input" id="user_name" name="name" required type="text" />
                      <!--                <span>이름을 입력해주세요.</span>-->
                      <span class="info_msg"></span>
                    </div>
                  </li>
                  <li>
                    <div class="left_content">
                      <label for="phone">휴대전화</label>
                    </div>
                    <div class="right_content">
                      <input class="login_input" id="phone" name="phone" required type="tel" maxlength="11">
                      <!--                <button id="phone_chk">인증</button>-->
                      <!--                <span>휴대전화를 입력해 주세요</span>-->
                      <span class="info_msg">(- 없이 입력해주세요.)</span>
                    </div>
                  </li>
                  <li>
                    <div class="left_content">
                      <label for="recommend" class="no_need">추천인 휴대전화</label>
                    </div>
                    <div class="right_content">
                      <input class="login_input" id="recommend" name="recommend" type="tel" maxlength="11">
                      <!--                <button id="phone_rec_user_chk">확인</button>-->
                      <span class="info_msg">(- 없이 입력해주세요.)</span>
                    </div>
                  </li>
                </ul>
              </div>

              <div class="pannelinfo_msg_wrap">
                <div class="pannel_info_contents">
                  <h1>폴인사이트의 패널이 된다면?</h1>
                  <p>폴인사이트에서 진행하는 각종 조사에 참여하실 수 있습니다.</p>
                  <p>참여한 조사에 따라 포인트를 현금으로 지급받으실 수 있습니다.</p>
                  <p>폴's 인사이트 게시판을 통해 조사 주요 결과를 확인하실 수 있습니다.</p>
                  <p>패널로 가입하시겠습니까?</p>
                </div>
                <div class="pannel_select">
                  <div class="radio_wrap">
                    <label>
                      <input name="ispanel" type="radio" value="true">
                      가입하고 혜택받기
                    </label>
                  </div>
                  <div class="radio_wrap">
                    <label>
                      <input name="ispanel" type="radio" value="false">
                      가입 안함
                    </label>
                  </div>
                </div>
              </div>
              <div class="btn_wrap">
                <button type="submit" class="btn_submit" id="frmsubmit">확인</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="popup_overlay">
        <div class="popup_box">
          <div id="popup_close_btn" style="position: relative; float: right; margin: 7px 10px; font-size: 20px; cursor:pointer;">
            <i class="fas fa-times"></i>
          </div>
          <div class="popup_content">
            <h3>폴인사이트에서 진행하는 각종 조사에 참여하실 수 없습니다.</h3>
          </div>
          <div class="popup_btn_wrap">
            <button type="button" class="popup_btn">확인</button>
          </div>
        </div>
      </div>
    </div>
    <th:block th:include="layout/footer" />
  </div>
  <script>
    // 필수 입력값 검사
    const checkNotNull = () => {
      let result = true
      $("form").find('input').each(function () {
        let inputElem = $(this)
        let label = inputElem.parent('.right_content').prev('.left_content').children('label')
        let inputValue = inputElem.val().trim()
        if ($(this).prop('required') && !inputValue) {
          inputElem.focus()
          inputElem.val('')
          alert(label.text().trim() + " 항목은 필수 입력 사항입니다.")
          result = false
          return false;
        }
      })

      return result;
    }


    const debounceCallEmailCheck = _.debounce((email, callback) => {
      http.get("/api/user/" + email)
          .then(res => callback(res.data.response))
          .catch(err => console.log("error", err))
    }, 200)

    const emailChecker = (e) => {
      /* 5 ~ 20자 제한 */
      const regex = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z]){5,20}@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i;
      const emailValue = String($("input[name=email]").val()).trim();
      const emailDomain = $("#email_domain").val().trim();
      const email = emailValue + '@' + emailDomain;
      const msg = $("#email_msg").css('display', 'block')

      if (!emailValue) {
        msg.text("").removeClass("correct_msg").addClass("err_msg")
      } else {
        if (emailInputValidator(email)) {
          debounceCallEmailCheck(email, function (status) {
                if (status) {
                  msg.text("사용 가능한 이메일입니다.").removeClass("err_msg").addClass("correct_msg")
                } else {
                  msg.text("이미 존재하는 이메일입니다. 다른 이메일을 입력해주세요").removeClass("correct_msg").addClass("err_msg")
                }
              }
          )
        } else {
          msg.text("올바른 이메일을 입력해주세요").removeClass("correct_msg").addClass("err_msg")
        }

      }
    }

    $(function () {

      $(document).on('focus', '.login_input', function () {
        $(this).css('border-bottom', '1.5px solid #4C99CF');
      });

      $(document).on('blur', '.login_input', function () {
        $(this).css('border-bottom', '1.5px solid #dde0ea');
      });

      $('input[name=email]').on('keyup change', emailChecker)

      // 유저 전화번호
      $("#phone").on('keypress', (e) => {
        let keycode = e.keyCode
        if (!(48 <= keycode && keycode <= 57)) {
          e.preventDefault();
          e.returnValue = false;
          alert('숫자만 입력 가능합니다.')
        }
      })

      $('input[type=tel]')
          .on('focus', phoneDelHypen)
          .on('blur', phoneAddHypen)

      // 추천인 전화번호
      $("#recommend").on('keypress', (e) => {
        let keycode = e.keyCode
        if (!(48 <= keycode && keycode <= 57)) {
          e.preventDefault();
          e.returnValue = false;
          alert('숫자만 입력 가능합니다.')
        }
      })

      $("input[name=ispanel]").on('click', (e) => {
        if (e.target.value === "false") {
          $(".popup_overlay").fadeIn(100)
        }
      })
      $("#popup_close_btn>i").on('click', (e) => {
        $('input[name=ispanel][type=radio][value=false]').prop('checked', false)
        $('.popup_overlay').fadeOut(100)
      })

      $(".popup_btn").on('click', (e) => {
        $('input[name=ispanel][type=radio][value=false]').prop('checked', true)
        $(".popup_overlay").fadeOut(100)
      })

      $('.popup_overlay').on('click', function () {
        $(this).css('display', 'none')
      })

      const userInfo = {}
      $('input').on('change', e => {
        userInfo[e.target.name] = e.target.value
      }).on('click', e => userInfo[e.target.name] = e.target.value)
      $('select').on('change', e => {
        userInfo[e.target.name] = e.target.value
      }).trigger('change')

      $("#frmsubmit").on('click', (e) => {
        e.preventDefault()
        e.stopPropagation()
        console.log(userInfo)
        if (checkNotNull()) {
          userInfo['email'] = stringToEmail(userInfo['email'], userInfo['domain'])
          userInfo['phone'] = stringToPhone(userInfo['phone'])
          if (!!userInfo['recommend'])
            userInfo['recommend'] = stringToPhone(userInfo['recommend'])
          if (userInfo['password'] !== userInfo['confirm']) {
            $('input[name=confirm]').val('')
            $('input[name=password]').val('').focus()
            alert('비밀번호를 다시 확인해주세요')
            return;
          } else if (!passwordInputValidator(userInfo['password'])) {
            $('input[name=confirm]').val('')
            $('input[name=password]').val('').focus()
            alert('비밀번호를 형식에 맞게 지정해주요')
            return;
          }
          if (userInfo['phone'] === userInfo['recommend']) {
            $('input[name=recommend]').val('').focus()
            alert('연락처와 추천인 연락처는 같을 수 없습니다.')
            return
          }
          if (!userInfo['ispanel']) {
            $('input[name=ispanel]').val('').focus()
            alert('패널 가입 여부를 확인해주세요')
            return;
          }
          delete userInfo.confirm
          delete userInfo.domain
          console.log(userInfo)
          http
              .post('/signup', userInfo)
              .then(res => {
                if (res.data.success) {
                  console.log(res.data, userInfo['ispanel'])
                  if (String(userInfo['ispanel']).toUpperCase() === 'TRUE') {
                    location.replace('/panel')
                  } else {
                    location.replace('/success_basic')
                  }
                } else {
                  alert('처리 중 오류가 발생하였습니다.\n관리자에게 문의해주세요.')
                }
              })
              .catch(err => {
                console.log("Error response", err)
                alert('처리 중 오류가 발생하였습니다.\n관리자에게 문의해주세요.')
              })
        }
      })

      $('input[name=password]').on('keyup', function (e) {
        if (!passwordInputValidator(e.target.value)) {
          $(this).next('span.err_msg').css('display', 'block')
        } else if (!!e.target.value || passwordInputValidator(e.target.value)) {
          $(this).next('span.err_msg').css('display', 'none')
        }
      })
      $('input[name=pwdconfirm]').on('keyup', (e) => {
        if (!passwordInputValidator(e.target.value)) {
          $(this).next('span.err_msg').css('display', 'block')
        } else if (!!e.target.value || passwordInputValidator(e.target.value)) {
          $(this).next('span.err_msg').css('display', 'none')
        }
      })

      $('.left_content>label').last().css('background', 'none')

    })

  </script>
</th:block>