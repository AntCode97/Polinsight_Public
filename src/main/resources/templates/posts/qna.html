<th:block th:include="layout/header" />
<th:block>
  <style>
    .header_wrap {
      background-color : rgb(24, 40, 56) !important;
    }

    .container {
      margin-top : 120px;
      width      : 100%;
    }

    .board_contents_wrap {
      margin    : auto;
      max-width : 1200px;
    }
  </style>
  <div class="container">
    <div class="board_contents_wrap">
      <div class="main_item">
        <p>Q&A</p>
      </div>
      <div class="main_contents_wrap">
        <div class="post-search">
          <div class="util-search">총 <strong id="total_count"></strong>명의 게시물이 있습니다.</div>
          <div class="form-search">
            <div class="tbl-search">
              <div class="box-search">
                <input type="text" name="board_search" />
                <input type="submit" name="board_search_btn" />
              </div>
            </div>
          </div>
        </div>
        <div class="scroll-table">
          <div class="post-row post-th">
            <span>번호</span>
            <a href="#">제목</a>
            <span>작성자</span>
            <span>작성일</span>
            <span>조회수</span>
            <span>첨부파일</span>
          </div>
        </div>
        <!--        인증된 유저 글쓰기 가능-->
        <div sec:authorize="hasAnyAuthority('USER','PANEL', 'BEST')">
          <button name="add_question_btn">질문 등록</button>
        </div>
        <!--        미 인증 유저 로그인 유도-->
        <div sec:authorize="isAnonymous()">
          <button name="anonymous_add_question_btn">질문 등록</button>
        </div>
        <div class="page-button" id="pagination"></div>
      </div>
    </div>
    <div id="loading">
      <div class="spinner"></div>
    </div>
  </div>
  <script th:src="@{/js/PostUtils.js}"></script>
  <script>
    async function getPostData(e) {
      let page = !e ? 0 : e.data.page
      let regex = String($('input[name=board_search]').val()).trim()
      const responseData = await http.get('/api/posts?type=QNA', {
        params: {page: page, size: 10}
      })
      const data = responseData.data.response

      return {content: data.content, total: data.totalElements, totalPage: data.totalPages, current: data.number, keyword: regex}
    }

    const init = e => {
      const spinner = $('#loading')
      spinner.show()
      getPostData(!e ? 0 : e.data.page).then(obj => {
        $('#total_count').text(obj.total)
        let table = $('.scroll-table')
        table.children('.post-row:not(:first-child)').remove()
        if (obj.total > 0) {
          makePagination(obj.current, obj.totalPage)
          searchMessage(obj.keyword, obj.total, '게시물이')
          obj.content.forEach(post => {
            table.append(makePostTemplate(post))
          })
        } else {
          table.append($(`<div class="post-row"><h1>게시물이 없습니다.</h1></div>`))
        }
      })
      spinner.hide()
    }

    $(function () {
      init();

      $('input[name=board_search]').on('keyup', {page: 0}, _.throttle(init, 300))
      $('input[name=board_search_btn]').on('click', {page: 0}, _.throttle(init, 300))
    })

    $(document)
        .on('click', 'button[name=add_question_btn]', function () {
          // go create question post
          // TODO
        })
        .on('click', 'button[name=anonymous_add_question_btn]', function () {
          // go login
          location.assign('/login')
        })

  </script>
</th:block>
<th:block th:include="layout/footer" />