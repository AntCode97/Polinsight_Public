<th:block th:include="admin/admin_sidebar"/>
<th:block th:include="module/common" />
<th:block>
  <style>
    /*.board-row:hover {*/
    /*  background-color: lightgray;*/
    /*}*/
  </style>
</th:block>
<th:block>
  <div class="admin_main_contents">
    <div class="admin_main_contents_category">
      <div class="admin_main_contents_item">
        <p class="main_item">회원 목록</p>
      </div>
    </div>

    <div class="main_contents_wrap">
      <div class="board-search">
        <div class="util-search">총 <strong></strong>명의 회원이 있습니다.</div>
      </div>
      <!--관리자 페이지 사용자 찾기 기능-->
      <div class="form-search">
        <div class="tbl-search">
          <div class="box-search">
            <input name="adminfinduserby" type="text" />
            <button name="adminfinduser_btn" type="submit">찾기</button>
          </div>
        </div>
      </div>

      <div class="scroll-table">
      </div>
      <div class="pagination"></div>
    </div>
  </div>

  <script>
    const goUserInfoDetail = () => {

    }

    const getHeader = () => {
      let header = `<div class="board-row board-th">`
      header += `<span>번호</span>`
      header += `<span>아이디(이메일)</span>`
      header += `<span>이름</span>`
      header += `<span>휴대전화</span>`
      header += `<span>유형</span>`
      header += `</div>`
      return header;
    }

    const makePaginationButton = current => {
      const size = 10;
      // 전체 요소 갯수 가져오기
      const userCount = $('div.util-search').children('strong').text()
      let totalPage = Math.floor(userCount / 10)  // 총 페이지 수
      const pagenationElem = $('div.pagination').css('text-align', 'center').css('margin', '0')
      pagenationElem.empty()

      let start = current - 5 <= 0 ? 0 : current - 5;
      let end = current + 5 > totalPage ? totalPage : current + 5 < 10 ? 10 : current + 5;

      // 못가게 되면 비활성화
      let gofirstArrow = addPagenationEvent($(`<div class="pagenation_button" onclick="getMemberList(${0})"><i class="fas fa-angle-double-left"></i></div>`))
      let goLastArrow = addPagenationEvent($(`<div class="pagenation_button" onclick="getMemberList(${totalPage - 1})"><i class="fas fa-angle-double-right"></i></div>`))
      let prev = addPagenationEvent($(`<div class="pagenation_button" onclick="getMemberList(${current - 1 < 0 ? 0 : current - 1})"><i class="fas fa-angle-left"></i></div>`))
      let next =
          addPagenationEvent($(`<div class="pagenation_button" onclick="getMemberList(${current + 1 >= totalPage ? totalPage - 1 : current + 1})"><i class="fas fa-angle-right"></i></div>`))
      // first arrow
      pagenationElem.append(gofirstArrow)
      // prev arrow
      pagenationElem.append(prev)

      for (let i = start; i < end; i++) {
        let tmp = $(`<div onclick="getMemberList(${i})" class="pagenation_button">${i + 1}</div>`)
        tmp = addPagenationEvent(tmp)
        // 활성화된 버튼에 대해 디자인 처리
        if (current === i) {
          tmp.css('color', 'rgba(32, 205, 195, 1)').css('background-color', 'rgba(240, 240, 240, 1)').css('font-weight', 'bold')
        }
        pagenationElem.append(tmp)
      }
      // next arrow
      pagenationElem.append(next)
      // last arrow
      pagenationElem.append(goLastArrow)
    }

    const addPagenationEvent = elem => {
      elem.on('mouseover', function () {
        $(this).css('cursor', 'pointer').css('text-decoration', 'underline')
      }).on('mouseleave', function () {
        $(this).css('cursor', 'default').css('text-decoration', 'none')
      })
      elem.css('width', '7px').css('height', '7px').css('display', 'inline').css('margin', '5px')
      return elem;
    }

    const makeAdminMemberRowTemplate = memberInfo => {
      let template = `<div class="board-row">`
      template += `<span>${memberInfo.id}</span>`
      template += `<span>${memberInfo.email}</span>`
      template += `<span>${memberInfo.name}</span>`
      template += `<span>${memberInfo.phone}</span>`
      template += `<span>${memberInfo.role}</span>`
      template += `</div>`
      return template;
    }

    const makeAdminMemberListTemplate = memberInfoList => {
      if (!memberInfoList) return
      const table = $('.scroll-table')
      table.empty()
      table.append(getHeader())
      for (memberInfo of memberInfoList)
        table.append(makeAdminMemberRowTemplate(memberInfo))
    }

    /*
    * @Param  offset : 페이지 번호
    * */
    const getMemberList = current => {
      const size = 10;

      axios.get('/api/users', {
            params: {
              'size': size,
              'offset': current
            }
          })
          .then(res => {
            console.log(res)
            if (res.data.response.length > 0) {
              makePaginationButton(current)
              makeAdminMemberListTemplate(res.data.response)
            }
          })
          .catch()
    }


    const countAllUsers = () => {
      axios.get('/api/user/total')
          .then(res => {
            $('div.util-search').children('strong').text(res.data.response)
          })
          .catch()
    }

    const findUserByRegex = e => {
      const findValue = $('input[name=adminfinduserby]').val()
      let url = ''
      if (!findValue) url = '/api/users'
      else url = '/api/user/find/' + findValue

      axios.get(url)
          .then(res => {
            $('div.util-search').children('strong').text(res.data.response.length)
            makeAdminMemberListTemplate(res.data.response)
            makePaginationButton(0)
          }).catch(err => console.log(err))
    }

    const throttleFindUserByRegex = _.throttle(findUserByRegex, 300)

    $(function () {
      countAllUsers()
      getMemberList(0)  // 페이지 초기 값

      $(document).on('click', 'div.board-row', () => {
        // 클릭시 디테일 페이지?
        alert('aaa')
      }).on('mouseover', 'div.board-row', function (e) {
        $(this).css('background-color', 'lightgray')
        $(this).css('cursor', 'pointer')
      }).on('mouseleave', 'div.board-row', function () {
        $(this).css('background-color', 'rgba(0,0,0,0)')
        $(this).css('cursor', 'default')
      })

      /*비동기 회원 찾기 및 화면 업데이트*/
      $('input[name=adminfinduserby]').on('keyup', throttleFindUserByRegex)
      $('button[name=adminfinduser_btn]').on('click', findUserByRegex).css('font-weight', 'bolder')
    })
  </script>
</th:block>