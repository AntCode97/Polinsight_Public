<th:block th:include="admin/admin_sidebar" />
<th:block>
  <style>
    table, tr, th, td {
      margin : 0;
      width  : 100%;
    }

    .post-row > *:nth-child(1) {
      width : 50px;
    }

    .post-row > *:nth-child(2) {
      width : 500px;
    }

    tbody > .post-row > td:nth-child(2) {
      text-align : left;
    }

    .post-row > *:nth-child(3) {
      width : 80px;
    }

    .post-row > *:nth-child(4) {
      width : 100px;
    }

    .post-row > *:nth-child(5) {
      width : 100px;
    }

    .post-row > *:nth-child(6) {
      width : 100px;
    }

    .post-row > *:nth-child(7) {
      width : 120px;
    }

    .post-row > *:nth-child(8) {
      width : 120px;
    }

    .post-row > *:nth-child(9) {
      width : 120px;
    }

    table {
      align : center;
    }

    .info_popup_container {
      background-color : red;
      display          : none;
      height           : 100%;
      position         : absolute;
      width            : 100%;
    }

    .info_popup {
      left      : 50%;
      top       : 50%;
      transform : translate(-50% -50%);
    }

    .status_wrap {
      align-items     : center;
      display         : flex;
      gap             : 5px;
      justify-content : center;
    }

    .status_wrap > * {
      cursor : pointer;
    }

    .status_box:nth-child(1) {
      color : mediumseagreen;
    }

    .status_box:nth-child(2) {
      color : tomato;
    }

    .survey_sort_wrap {
      align-items     : center;
      display         : flex;
      gap             : 15px;
      justify-content : flex-start;
      padding-bottom  : 10px;
      padding-left    : 10px;
    }

    .survey_sort_wrap > input {
      display : none;
    }

    .survey_sort_wrap > label {
      color       : inherit;
      cursor      : pointer;
      display     : inline-block;
      font-size   : 1.2rem;
      font-weight : normal;
    }

    .check_sort {
      color           : tomato !important;
      text-decoration : underline;
    }

    .err_msg {
      display : none;
    }

    /* MODAL DESIGN */
    /* Modal Page Design */
    .modal_wrap {
      align-items      : center;
      background-color : rgba(0, 0, 0, 0.4);
      display          : none;
      height           : 100%;
      justify-content  : center;
      overflow         : auto;
      position         : fixed;
      top              : 0;
      width            : 100%;
      z-index          : 1000;
    }

    .modal_contents_box {
      background-color : white;
      border-radius    : 5px;
      box-shadow       : 0 4px 10px 0 rgb(0 0 0 / 20%), 0 4px 20px 0 rgb(0 0 0 / 19%);
      padding          : 20px;
      position         : relative;
    }

    .btn_close {
      cursor   : pointer;
      height   : 20px;
      margin   : 8px;
      position : absolute;
      right    : 0;
      top      : 0;
      width    : 20px;
    }

    .btn_close > i {
      color     : #192739;
      display   : block;
      font-size : 25px;
    }

    .bottom_box {
      background-color : white;
      border-radius    : 5px;
      display          : flex;
      font-size        : 1rem;
      justify-content  : center;
      margin-top       : 10px;
      overflow         : hidden;
      padding          : 10px;
      width            : 100%;
    }

    .tab_box {
      display    : none;
      max-height : 85vh;
      overflow   : auto;
    }

    .user_input_box {
      align-items     : center;
      display         : flex;
      justify-content : flex-start;
      margin-bottom   : 10px;
      position        : relative;
    }

    .user_input_box > .info_article {
      margin : 0;
      width  : 105px;
    }

    .user_input_box > .user_info_input {
      border        : none;
      border-bottom : 1px solid #DDDDDD;
      position      : relative;
      width         : 200px;
    }

    .user_basic_wrap {
      display        : flex;
      flex-direction : row;
      gap            : 10px;
      margin-bottom  : 1rem;
      margin-top     : 0.5rem;
      min-width      : 750px;
    }

    .user_info_box {
      border  : 1px solid #C5C7D0;
      flex    : 1;
      padding : 13px 20px;
    }

    .info_article {
      color         : #69666D;
      display       : block;
      font-size     : 1.1rem;
      margin-bottom : .35rem;
    }

    .user_readonly_box {
      background-color : #F1F2F7;
      border           : .1rem solid transparent;
      cursor           : not-allowed;
      flex             : 1;
    }

    .user_info_input {
      border        : none;
      border-bottom : 1px solid #DDDDDD;
      color         : #333333;
      font-size     : 14px;
      height        : 32px;
      line-height   : 32px;
      outline       : none;
      width         : 100%;
    }

    .user_btn_wrap {
      display : flex;
    }

    .mypage_btn {
      background    : #192739;
      border        : none;
      border-radius : 2px;
      color         : white;
      cursor        : pointer;
      font-size     : 14px;
      font-weight   : normal;
      padding       : 8px 15px;
      transition    : box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1);
    }

    .mypage_btn:hover {
      box-shadow : 0 14px 26px -12px hsl(0deg 0% 60% / 42%), 0 4px 23px 0 rgb(0 0 0 / 12%), 0 8px 10px -5px hsl(0deg 0% 60% / 20%);
    }

    .delete_btn {
      background-color : tomato;
    }

    .btn_box {
      align-items : center;
      display     : flex;
      gap         : 5px;
    }

    .item_header {
      align-items     : center;
      display         : flex;
      font-size       : 1.3rem;
      gap             : 5px;
      justify-content : flex-start;
      margin-bottom   : 20px;
    }

    .status_wrap > * {
      cursor : pointer;
    }

    .status_box:nth-child(1) {
      color : mediumseagreen;
    }

    .status_box:nth-child(2) {
      color : tomato;
    }

    .date_wrap {
      align-items     : center;
      display         : flex;
      gap             : 10px;
      justify-content : center;
      width           : 100%;
    }
  </style>
  <div class="modal_wrap">
    <div class="modal_contents_box">
      <div class="btn_close"><i class="fas fa-times"></i></div>

      <div class="bottom_box">
        <div class="tab_box box01" style="display: block;">
          <form action="" method="">
            <div class="item_header">
              <span><i class="fas fa-poll-h" style="padding-right: 3px; color: #4C99CF;"></i>설문정보</span>
            </div>
            <div>
              <span>썸네일 업로드</span>
              <span><input name="thumbnail" type="file"></span>
            </div>
            <div class="item_content">
              <div class="user_basic_wrap">
                <div id="survey_id" class="user_info_box user_readonly_box">
                  <span class="info_article">설문아이디</span>
                  <p>2</p>
                  <input type="hidden" name="id" readonly>
                </div>
                <div id="survey_title" class="user_info_box user_readonly_box" style="flex: 8;">
                  <span class="info_article">설문제목</span>
                  <p>2021년 전라남도 청소년 실태조사[대학생]</p>
                  <input type="hidden" name="title" readonly>
                </div>
              </div>
              <div id="survey_point" class="user_basic_wrap">
                <div class="user_info_box user_point_box">
                  <span class="info_article">포인트</span>
                  <input type="text" class="user_info_input" name="point" value="300" />
                </div>
                <div id="survey_progress" class="user_info_box user_status_box">
                  <span class="info_article">진행상태</span>
                  <select name="progress" class="user_info_input" style="cursor: pointer;">
                    <option name="progress" value="BEFORE">등록</option>
                    <option name="progress" value="ONGOING">진행</option>
                    <option name="progress" value="END">종료</option>
                  </select>
                </div>
              </div>
              <div class="user_basic_wrap">
                <div class="user_info_box user_regdate_box">
                  <span class="info_article">설문기간</span>
                  <div id="survey_duration" class="date_wrap">
                    <input type="date" name="create" class="user_info_input" style="cursor: pointer;" />
                    <span> ~ </span>
                    <input type="date" name="end" class="user_info_input" style="cursor: pointer;" />
                  </div>
                </div>
              </div>

              <div class="user_btn_wrap" style="justify-content: flex-start;">
                <span class="err_msg"></span>
              </div>
              <div class="user_btn_wrap" style="justify-content: flex-end;">
                <div class="btn_box" id="modal_btn">
                  <button type="button" name="delete" class="mypage_btn delete_btn"><i class="fas fa-trash-alt" style="padding-right: 5px; font-weight: normal; font-size: 17px;"></i>삭제
                  </button>
                  <button type="button" name="update" class="mypage_btn update_btn"><i class="fas fa-edit" style="padding-right: 5px; font-weight: normal; font-size: 17px;"></i>수정</button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="admin_main_contents">
    <div class="admin_main_contents_category">
      <div class="admin_main_contents_item">
        <p class="main_item">설문 목록</p>
      </div>
    </div>

    <div class="main_contents_wrap">
      <div class="post-search">
        <div class="util-search"></div>

        <!--관리자 페이지 설문 찾기 기능-->
        <div class="form-search">
          <div class="tbl-search">
            <div class="box-search">
              <input name="admin_find" type="text" />
            </div>
          </div>
        </div>
      </div>
      <div class="survey_sort_wrap">
        <label for="sort_all" class="check_sort">
          전체
        </label>
        <input value="ALL" type="radio" name="sort_group" id="sort_all" checked />
        <label for="sort_before">
          등록
        </label>
        <input value="BEFORE" type="radio" name="sort_group" id="sort_before" />
        <label for="sort_ongoing">
          진행
        </label>
        <input value="ONGOING" type="radio" name="sort_group" id="sort_ongoing" />
        <label for="sort_end">
          종료
        </label>
        <input value="END" type="radio" name="sort_group" id="sort_end" />
      </div>
      <table class="scroll-table">
        <thead>
        <tr class="post-th post-row">
          <th>번호</th>
          <th>설문 이름</th>
          <th>포인트</th>
          <th>설문 시작일</th>
          <th>설문 종료일</th>
          <th>진행 상태</th>
          <th>참여자 수</th>
          <th>설문 아이디</th>
        </tr>
        </thead>
        <tbody>

        </tbody>
      </table>
      <div class="page-button" id="pagination"></div>
    </div>
  </div>
  <script th:src="@{/js/PostUtils.js}"></script>
  <script th:src="@{/js/Validator.js}"></script>
  <script>
    const setDataInModal = e => {
      let survey = e.data.survey;
      $('#survey_id').find('p').text(survey.id);
      $('input[name=id]').val(survey.id)
      $('#survey_title').find('p').text(survey.title);
      $('input[name=title]').val(survey.title)
      $('#survey_point').find('input').val(!survey.point ? -1 : survey.point);
      $('#survey_progress').find('select').val(survey.progress);
      $('#survey_duration').find('input[name=create]').val(survey.createdAt);
      $('#survey_duration').find('input[name=end]').val(survey.endAt);
      $('#modal_btn').find('button[name=update]').on('click', {survey: survey}, surveyUpdate);
      $('#modal_btn').find('button[name=delete]').on('click', {survey: survey}, surveyDelete);
    };

    async function getSurveyData(e) {
      let type = $('input[name=sort_group]:checked').val();
      let page = !e ? 0 : !e.data.page ? 0 : e.data.page;
      let regex = !e ? '' : String($('input[name=admin_find]').val()).trim();
      const response = await http.get('/api/surveys?type=' + type, {params: {page: page, size: 10, regex: regex}});
      if (response.data.success) {
        const data = response.data.response;
        return {content: data.content, total: data.totalElements, totalPage: data.totalPages, current: data.number, keyword: regex};
      }
    }

    async function uploadSurveyThumbnail(thubmnail, surveyId) {
      console.log("섬네일 저장")
      let frmData = new FormData()
      frmData.append('thumbnail', thubmnail)
      let response = await http.post(`/api/survey/thumbnail/${surveyId}`, frmData, {
        headers: {'Content-Type': 'multipart/form-data'}
      })

      return response.data.success
    }

    const surveyUpdate = e => {
      e.stopPropagation()
      e.preventDefault()
      let info = {
        id: $('input[name=id]').val(),
        point: $('input[name=point]').val(),
        progress: $('select[name=progress]').val(),
        title: $('input[name=title]').val(),
        createdAt: $('input[name=create]').val(),
        endAt: $('input[name=end]').val(),
      }

      uploadSurveyThumbnail($('input[name=thumbnail]').prop('files')[0], info.id)
      // 데이터 검증
      if (!isValidSurveyUpdateInfo(info)) {
        alert('올바른 값을 입력해주세요')
        return
      }

      if (confirm('정말 설문을 업데이트 하시겠습니까?')) {
        http
            .put('/api/survey', info)
            .then(res => {
              if (res.data.success)
                alert('업데이트 성공')
            })
            .catch(err => {
              alert('설문 업데이트 중 오류가 발생하였습니다.\n계속해서 오류가 발생한다면 관리자에게 문의해주세요.')
            })
            .finally(() => init())
      }
    }
    const surveyDelete = e => {
      e.stopPropagation()
      e.preventDefault()
      let survey = e.data.survey
      // 검증 후 삭제
      if (confirm(`정말\n${survey.title}\n설문을 삭제하시겠습니까?`)) {
        http
            .delete('/api/survey', survey)
            .then(res => {
              if (res.data.success)
                alert('삭제 성공')
            })
            .catch(err => {
              alert('설문 삭제 중 오류가 발생하였습니다.\n계속해서 오류가 발생한다면 관리자에게 문의해주세요.')
            })
            .finally(() => init())
      }
    }

    const init = e => {
      getSurveyData(e).then(obj => {
        $('#total_count').text(obj.total);
        const table = $('.scroll-table');
        table.children('.post-row:not(:first-child)').remove();
        if (obj.total > 0) {
          console.log(obj.current + " " +obj.totalPage );
          makePagination(obj.current, obj.totalPage);
          searchMessage(obj.keyword, obj.total, '설문이')
          obj.content.forEach(survey => {
            table.append(makeSurveyTemplate(survey));
          });
        } else {
          table.append(`<div class="post-row"><h1>설문이 존재하지 않습니다.</h1></div>`);
        }
      })
    }

    $(function () {
      init();
      $('input[name=admin_find]').on('keyup', {page: 0}, _.throttle(init, 300));
      $('input[name=sort_group]')
          .on('click', {page: 0}, init)
          .on('change', function (e) {
            let id = e.target.id;
            $('input[name=sort_group]').each(function () {
              if (id === $(this).attr('id')) {
                $(this).prev().addClass('check_sort');
              } else {
                $(this).prev().removeClass('check_sort');
              }
            });
          });
    })

    /* 동적 웹디자인 및 유효성 체크 */
    $(document)
        .on('focus', '.user_info_input', function () {
          $(this).css('border-bottom', '1px solid #4C99CF');
          $(this).prevAll('.info_article').css('color', '#4C99CF');
          $(this).parent().prevAll('.info_article').css('color', '#4C99CF');
          $(this).parents('.user_info_box').css('border', '1px solid #4C99CF');
        })
        .on('blur', '.user_info_input', function () {
          $(this).css('border-bottom', '1px solid #c5c7d0');
          $(this).prevAll('.info_article').css('color', '#69666D');
          $(this).parent().prevAll('.info_article').css('color', '#69666D');
          $(this).parents('.user_info_box').css('border', '1px solid #c5c7d0');
        })
        .on('hover', '.post-row:not(:first-child)', function () {
          $(this).css('cursor', 'pointer')
        })
        .on('keyup', 'input[name=point]', function (e) {
          e.stopPropagation()
          e.preventDefault()
          let msg = $('.err_msg')
          if ($(this).val().length > 0) {
            if (!checkNumber(e)) {
              msg.show().text('포인트는 숫자만 입력 가능합니다.')
            } else {
              msg.hide().text('')
            }
          } else {
            msg.hide().text('')
          }
        })
        .on('change', 'input[name=end]', function (e) {
          e.stopPropagation()
          e.preventDefault()
          let msg = $('.err_msg')
          if ($(this).val().length > 0) {
            if (!isValidDate($(this).val())) {
              msg.show().text('올바른 날짜를 입력해주세요')
              $(this).focus()
            } else {
              msg.hide().text('')
            }
          } else {
            msg.hide().text('')
          }
        })
        .on('change', 'input[name=create]', function (e) {
          e.stopPropagation()
          e.preventDefault()
          let msg = $('.err_msg')
          let end = $('input[name=end]')
          let create = $(this)
          if (create.val().length > 0) {
            if (isValidDate(create.val())) {
              end.attr('min', dateParser(create.val().split("-")[0], create.val().split("-")[1], Number(create.val().split("-")[2]) + 1))
              msg.hide().text('')
            } else {
              msg.show().text('올바른 날짜를 입력해주세요')
            }
          } else {
            msg.hide().text('')
          }
        })
        .on('click', '.btn-update', function () {
          $('.modal_wrap').css('display', 'flex');
        })
        .on('click', '.btn_close', function () {
          $('.modal_wrap').css('display', 'none');
        })
        .on('click', '.post-row > *', function () {
          $('.modal_wrap').css('display', 'flex');
        });
  </script>
</th:block>