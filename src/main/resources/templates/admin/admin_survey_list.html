<th:block th:include="admin/admin_sidebar" />
<th:block>
  <th:block>
    <style>
      table, tr, th, td {
        margin : 0;
        width  : 100%;
      }

      .post-row > *:nth-child(1) {
        width : 50px;
      }

      .post-row > *:nth-child(2) {
        width : 500px;
      }

      tbody > .post-row > td:nth-child(2) {
        text-align : left;
      }

      .post-row > *:nth-child(3) {
        width : 80px;
      }

      .post-row > *:nth-child(4) {
        width : 100px;
      }

      .post-row > *:nth-child(5) {
        width : 100px;
      }

      .post-row > *:nth-child(6) {
        width : 100px;
      }

      .post-row > *:nth-child(7) {
        width : 120px;
      }

      .post-row > *:nth-child(8) {
        width : 120px;
      }

      .post-row > *:nth-child(9) {
        width : 120px;
      }

      table {
        align : center;
      }

      .info_popup_container {
        background-color : red;
        display          : none;
        height           : 100%;
        position         : absolute;
        width            : 100%;
      }

      .info_popup {
        left      : 50%;
        top       : 50%;
        transform : translate(-50% -50%);
      }

      .status_wrap {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5px;
      }
      .status_wrap > * {cursor: pointer;}
      .status_box:nth-child(1) {color: mediumseagreen;}
      .status_box:nth-child(2) {color: tomato;}
      .survey_sort_wrap {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 15px;
        padding-left: 10px;
        padding-bottom: 10px;
      }
      .survey_sort_wrap > input { display: none; }
      .survey_sort_wrap > label {
        display: inline-block;
        font-size: 1.2rem;
        font-weight: normal;
        color: inherit;
        cursor: pointer;
      }
      .check_sort { color: tomato!important; text-decoration: underline;}

      /* MODAL DESIGN */
      /* Modal Page Design */
      .modal_wrap {
        position: fixed;
        z-index: 1000;
        background-color: rgba(0,0,0,0.4);
        overflow: auto;
        width: 100%;
        height: 100%;
        display: none;
        justify-content: center;
        align-items: center;
        top: 0;
      }
      .modal_contents_box {
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 4px 10px 0 rgb(0 0 0 / 20%), 0 4px 20px 0 rgb(0 0 0 / 19%);
        position: relative;
        background-color: white;
      }
      .btn_close {
        position: absolute;
        top: 0;
        right: 0;
        width: 20px;
        height: 20px;
        cursor: pointer;
        margin: 8px;
      }
      .btn_close > i {
        color: #192739;
        font-size: 25px;
        display: block;
      }
      .bottom_box {
        display: flex;
        justify-content: center;
        width: 100%;
        padding: 10px;
        border-radius: 5px;
        overflow: hidden;
        background-color: white;
        margin-top: 10px;
        font-size: 1rem;
      }
      .tab_box {
        display: none;
        max-height: 85vh;
        overflow: auto;
      }
      .user_input_box {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin-bottom: 10px;
        position: relative;
      }
      .user_input_box > .info_article {
        width: 105px;
        margin: 0;
      }
      .user_input_box > .user_info_input {
        width: 200px;
        border: none;
        border-bottom: 1px solid #ddd;
        position: relative;
      }
      .user_basic_wrap {
        display: flex;
        flex-direction: row;
        margin-top: 0.5rem;
        margin-bottom: 1rem;
        gap: 10px;
        min-width: 750px;
      }

      .user_info_box {
        padding: 13px 20px;
        flex: 1;
        border: 1px solid #c5c7d0;
      }
      .info_article {
        display: block;
        color: #69666D;
        font-size: 1.1rem;
        margin-bottom: .35rem;
      }
      .user_readonly_box {
        background-color: #f1f2f7;
        border: .1rem solid transparent;
        flex: 1;
        cursor: not-allowed;
      }
      .user_info_input {
        width: 100%;
        outline: none;
        font-size: 14px;
        color: #333;
        border: none;
        border-bottom: 1px solid #ddd;
        height: 32px;
        line-height: 32px;
      }
      .user_btn_wrap { display: flex;}
      .mypage_btn {
        color: white;
        padding: 8px 15px;
        background: #192739;
        border-radius: 2px;
        border: none;
        font-size: 14px;
        font-weight: normal;
        cursor: pointer;
        transition: box-shadow .2s cubic-bezier(.4,0,1,1), background-color .2s cubic-bezier(.4,0,.2,1);
      }
      .mypage_btn:hover {
        box-shadow: 0 14px 26px -12px hsl(0deg 0% 60% / 42%), 0 4px 23px 0 rgb(0 0 0 / 12%), 0 8px 10px -5px hsl(0deg 0% 60% / 20%);
      }
      .delete_btn { background-color: tomato; }
      .btn_box {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .item_header {
        font-size: 1.3rem;
        align-items     : center;
        display         : flex;
        gap             : 5px;
        justify-content : flex-start;
        margin-bottom: 20px;
      }

      .status_wrap > * {
        cursor : pointer;
      }

      .status_box:nth-child(1) {
        color : mediumseagreen;
      }

      .status_box:nth-child(2) {
        color : tomato;
      }
      .date_wrap {
        display: flex;
        justify-content: center;
        width: 100%;
        gap: 10px;
        align-items: center;
      }
    </style>
  </th:block>
  <div class="modal_wrap">
    <div class="modal_contents_box">
      <div class="btn_close"><i class="fas fa-times"></i></div>

      <div class="bottom_box">
        <div class="tab_box box01" style="display: block;">
          <form action="" method="">
            <div class="item_header">
              <span><i class="fas fa-poll-h" style="padding-right: 3px; color: #4C99CF;"></i>설문정보</span>
            </div>
            <div class="item_content">
              <div class="user_basic_wrap">
                <div class="user_info_box user_readonly_box">
                  <span class="info_article">설문아이디</span>
                  <p>2</p>
                  <input type="hidden" name="id" readonly>
                </div>
                <div class="user_info_box user_readonly_box" style="flex: 8;">
                  <span class="info_article">설문제목</span>
                  <p>2021년 전라남도 청소년 실태조사[대학생]</p>
                  <input type="hidden" name="title" readonly>
                </div>
              </div>
              <div class="user_basic_wrap">
                <div class="user_info_box user_point_box">
                  <span class="info_article">포인트</span>
                  <input type="text" class="user_info_input" name="point" value="300" onkeypress='return checkNumber(event)'></input>
                </div>
                <div class="user_info_box user_status_box">
                  <span class="info_article">진행상태</span>
                  <select name="progress" class="user_info_input" style="cursor: pointer;">
                    <option name="progress" value="BEFORE">등록</option>
                    <option name="progress" value="ONGOING">진행</option>
                    <option name="progress" value="END">종료</option>
                  </select>
                </div>
              </div>
              <div class="user_basic_wrap">
                <div class="user_info_box user_regdate_box">
                  <span class="info_article">설문기간</span>
                  <div class="date_wrap">
                    <input type="date" name="create" class="user_info_input" style="cursor: pointer;">
                    <span> ~ </span>
                    <input type="date" name="end" class="user_info_input" style="cursor: pointer;">
                  </div>
                </div>
              </div>

              <div class="user_btn_wrap" style="justify-content: flex-start;">
                <span class="err_msg">에러 메세지!!</span>
              </div>
              <div class="user_btn_wrap" style="justify-content: flex-end;">
                <div class="btn_box">
                  <button type="button" class="mypage_btn delete_btn"><i class="fas fa-trash-alt" style="padding-right: 5px; font-weight: normal; font-size: 17px;"></i>삭제</button>
                  <button type="button" class="mypage_btn update_btn"><i class="fas fa-edit" style="padding-right: 5px; font-weight: normal; font-size: 17px;"></i>수정</button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="admin_main_contents">
    <div class="admin_main_contents_category">
      <div class="admin_main_contents_item">
        <p class="main_item">설문 목록</p>
      </div>
    </div>

    <div class="main_contents_wrap">
      <div class="post-search">
        <div class="util-search">총 <strong></strong>개의 설문이 있습니다.</div>

        <!--관리자 페이지 설문 찾기 기능-->
        <div class="form-search">
          <div class="tbl-search">
            <div class="box-search">
              <input type="text" id="searchinput" th:value="${keyword}" onchange="asyncFindBoard()" />
              <input type="submit" />
            </div>
          </div>
        </div>
      </div>
      <div class="survey_sort_wrap">
        <input type="radio" name="sort_group" id="sort_all">
        <label for="sort_all" class="check_sort">전체</label>
        <input type="radio" name="sort_group" id="sort_before">
        <label for="sort_before">등록</label>
        <input type="radio" name="sort_group" id="sort_ongoing">
        <label for="sort_ongoing">진행</label>
        <input type="radio" name="sort_group" id="sort_end">
        <label for="sort_end">종료</label>
      </div>
      <table class="scroll-table">
        <thead></thead>
        <tbody></tbody>
      </table>
      <div class="pagination"></div>
      <!--서베이 정보 팝업-->
      <div class="info_popup_container">
        <div class="info_popup">
          <h1>정보 팝업</h1>
        </div>
      </div>

    </div>
  </div>
  <script>


    const makePaginationsInAdminSurvey = current => {
      const regexValue = $('input[name=adminfindsurvey]').val();
      const surveyCount = parseInt($('.util-search>strong').text());
      const totalPage = Math.ceil(surveyCount / 10);

      let first = $(`<div class="pagination_button" ><i class="fas fa-angle-double-left"></i></div>`);
      let last = $(`<div class="pagination_button" ><i class="fas fa-angle-double-right"></i></div>`);
      let prev = $(`<div class="pagination_button" ><i class="fas fa-angle-left"></i></div>`);
      let next = $(`<div class="pagination_button" ><i class="fas fa-angle-right"></i></div>`);

      const paginationElement = $('div.pagination');
      paginationElement.empty();

      let start = current - 5 <= 0 ? 0 : current - 5;
      let end = totalPage < 10 ? totalPage : current + 5 > totalPage ? totalPage : current + 5 <= 10 ? current + 5 : 10;

      if (surveyCount === 0) {
        console.log('length 0');
        $('.scroll-table').empty().after(`<div class="empty-data"><h1>결과가 없습니다</h1></div>`);
        $('.pagination').empty();
      } else {
        // if (!regexValue) {
        first.on('click', {regex: !regexValue ? '' : regexValue, page: 0}, adminGetAllSurveys);
        last.on('click', {regex: !regexValue ? '' : regexValue, page: totalPage}, adminGetAllSurveys);
        prev.on('click', {regex: !regexValue ? '' : regexValue, page: current - 1 <= 0 ? 0 : current - 1}, adminGetAllSurveys);
        next.on('click', {regex: !regexValue ? '' : regexValue, page: current >= totalPage ? totalPage - 1 : current + 1}, adminGetAllSurveys);
        if (current > 0)
          paginationElement.append(first).append(prev);
        for (let i = start; i < end; i++) {
          let tmp = $(`<div class="pagination_button">${i + 1}</div>`);
          tmp.on('click', {page: i}, adminGetAllSurveys);
          if (current === i) {
            tmp.css('color', 'white').css('background-color', '#444444');
          }
          paginationElement.append(tmp);
        }
        if (current < totalPage - 1)
          paginationElement.append(next).append(last);
      }
      // } else {
      //   first.on('click', {regex: !regexValue ? '' : regexValue, page: 0}, adminGetAllSurveys);
      //   last.on('click', {regex: !regexValue ? '' : regexValue, page: totalPage}, adminGetAllSurveys);
      //   prev.on('click', {regex: !regexValue ? '' : regexValue, page: current - 1 <= 0 ? 0 : current - 1}, adminGetAllSurveys);
      //   next.on('click', {regex: !regexValue ? '' : regexValue, page: current >= totalPage ? totalPage - 1 : current + 1}, adminGetAllSurveys);
      //
      //   if (current >= 1)
      //     paginationElement.append(first).append(prev);
      //
      //   for (let i = start; i < end; i++) {
      //     let tmp = $(`<div class="pagination_button">${i + 1}</div>`);
      //     tmp.on('click', {page: i, regex: regexValue}, adminGetAllSurveys);
      //     if (current === i) {
      //       tmp.addClass('pagination_button_current');
      //     } else {
      //       tmp.removeClass('pagination_button_current');
      //     }
      //     paginationElement.append(tmp);
      //   }
      //
      //   if (current < totalPage - 1)
      //     paginationElement.append(next).append(last);
      // }
    }

    const surveyListHeader = () => {
      let template = $(`<tr class="post-th post-row"></tr>`);
      template.append(`<th>번호</th>`);
      template.append(`<th>설문 이름</th>`);
      template.append(`<th>포인트</th>`);
      template.append(`<th>설문 시작일</th>`);
      template.append(`<th>설문 종료일</th>`);
      template.append(`<th>진행 상태</th>`);
      template.append(`<th>참여자 수</th>`);
      template.append(`<th>설문 아이디</th>`);
      template.append(`<th>관리</th>`);
      return template;
    };

    const adminMakeSurveySearchResults = surveys => {
      const table = $('.scroll-table>tbody');
      table.empty();
      surveys.map(survey => {
        let template = $(`<tr class="post-row">`);
        template.append(`<td>${survey.id}</td>`);// 번호
        template.append(`<td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${survey.title}</td>`);// 설문 이름
        template.append(`<td>${!survey.point ? 0 : survey.point}</td>`);// 지급 포인트
        template.append(`<td>${String(survey.createdAt).split('T')[0] !== 'null' ? String(survey.endAt).split('T')[0] : 'N/A'}</td>`); // 설문 기간
        template.append(`<td>${String(survey.endAt).split('T')[0] !== 'null' ? String(survey.endAt).split('T')[0] : 'N/A'}</td>`)
        template.append(`<td>${survey.status.progress}</td>`);// 진행 상태
        template.append(`<td>${survey.status.count}</td>`);// 참여자 수
        template.append(`<td>${survey.surveyId}</td>`);// 서베이 아이디
        template.append(`<td><button class="btn_udel btn-support btn-update">수정</button><span>  </span><button class="btn_udel btn-warn">삭제</button></td>`);
        return template
      }).map(elem => table.append(elem))
    };

    const adminGetAllSurveys = e => {
      const regex = !e ? '' : !e.data.regex ? '' : '/' + e.data.regex;
      const offset = !e ? 0 : !e.data.page ? 0 : e.data.page;
      http.get('/api/test/surveys' + regex, {
        params: {size: 10, page: offset}
      })
              .then(res => {
                if (res.data.success) {
                  getTotalCount(regex);
                  makePaginationsInAdminSurvey(offset);
                  adminMakeSurveySearchResults(res.data.response);
                } else {
                  console.log('data fetching error');
                }
              })
              .catch(console.log);
    };

    const getTotalCount = regex => {
      if (!regex) {
        http.get('/api/survey/total')
                .then(res => $('.util-search>strong').text(res.data.response))
                .catch(console.log);
      } else {
        http.get('/api/survey/find/' + regex + '/total')
                .then(res => $('.util-search>strong').text(res.data.response))
                .catch(console.log);
      }
    };

    $(function () {
      $('.scroll-table>thead').append(surveyListHeader());
      getTotalCount();
      adminGetAllSurveys();

      /* 요소 클릭 이벤트 */
      // $(document).on('click', 'tbody > .post-row', function () {
      //   const id = $(this).children('td:first-child').text();
      //   location.href = `/admin/surveyinfo/${id}`
      // });

      $('input[name=admin_find]').on('keyup', _.throttle(adminGetAllSurveys, 300));
    });

    $(document).on('click', '.btn-update', function(){
      $('.modal_wrap').css('display', 'flex');
    });
    $(document).on('click', '.btn_close', function(){
      $('.modal_wrap').css('display', 'none');
    });
    $(document).on('click', '.post-row > *', function(){
      $('.modal_wrap').css('display', 'flex');
    });

    /* 동적 웹디자인 및 유효성 체크 */
    $(document).on('focus', '.user_info_input', function(){
      $(this).css('border-bottom', '1px solid #4C99CF');
      $(this).prevAll('.info_article').css('color', '#4C99CF')
      $(this).parent().prevAll('.info_article').css('color', '#4C99CF')
      $(this).parents('.user_info_box').css('border', '1px solid #4C99CF');
    });
    $(document).on('blur', '.user_info_input', function(){
      $(this).css('border-bottom', '1px solid #c5c7d0');
      $(this).prevAll('.info_article').css('color', '#69666D')
      $(this).parent().prevAll('.info_article').css('color', '#69666D')
      $(this).parents('.user_info_box').css('border', '1px solid #c5c7d0');
    });

    /* 유효성체크: 숫자만 입력 */
    function checkNumber(event) {
      if(event.key >= 0 && event.key <= 9) {
        return true;
      }
      return false;
    }
  </script>
</th:block>