<th:block th:include="admin/admin_sidebar" />
<th:block th:include="module/common" />
<th:block>
  <div class="admin_main_contents">
    <div class="admin_main_contents_category">
      <div class="admin_main_contents_item">
        <p class="main_item">공지사항</p>
      </div>
    </div>

    <section>
      <div id="metop_container">
        <div class="metop_inner">
          <div class="metop_board_wrap">
            <div class="metop_board_card" style="border-top: 3px solid #EBA444;">
              <form id="frm_board" th:action="@{/admin/posts/{id}/edit (id=${postDTO.id})}" th:object="${postDTO}" method="POST" enctype="multipart/form-data">
                <div class="input_wrap register_top_wrap">
                  <div class="board_div">
                    <label for="board_title"><span>*</span>게시판</label>
                    <span class="board_span">
                                          <select class="board_input focus_input board_select" name="btype" id="board_type" th:field="*{postType}" disabled required>
                                            <optgroup label="분류 선택">
                                            <option value="NOTICE">공지사항</option>
                                            <option value="ARCHIVES">자료실</option>
                                              <option value="EVENT">이벤트</option>
                                                 </optgroup>
                                          </select>
                                          <span class="size_limit_msg"><i class="fas fa-exclamation-circle"></i>(게시판은 저장 후 변경이 불가능합니다.)</span>
                                          <div class="err_msg_wrap err_title"><span class="err_msg">게시판 타입을 선택해주세요.:(</span></div>
                                        </span>
                  </div>
                  <div class="board_div">
                    <label for="board_title"><span>*</span>제목</label>
                    <span class="board_span">
                      										<input type="text" class="board_input focus_input" name="title" id="board_title" th:field="*{title}" required />
                                          <div class="err_msg_wrap err_title"><span class="err_msg">제목을 입력해주세요:(</span></div>
                      									</span>
                  </div>
                  <div class="board_div" id="writer_div">
                    <label for="board_title"><span>*</span>작성자</label>
                    <span class="board_span">
                                          <input type="text" class="board_input board_writer" name="writer" id="board_writer" th:value="*{user.name}" readonly />
                                        </span>
                  </div>
                  <div class="board_div" id="thumbnail_div">
                    <label for="board_title"><span>*</span>썸네일 이미지</label>
                    <span class="board_span">

                      <img th:if="*{thumbnail}" th:src="'/files/'+*{thumbnail}" >
                                          <input type="file" class="board_input" th:field="*{thumbnailImg}" accept="image/*"/>
                                        </span>
                  </div>
                </div>
                <!-- 게시글 내용 등록(스마트에디터) -->
                <div class="input_wrap textarea_div">
                  <div class="board_content_wrap">
                    <textarea id="board_content" name="viewcontent" class="board_content focus_input" th:field="*{content}" style="width: 100%;"></textarea>
                    <div class="err_msg_wrap err_info"><span class="err_msg">내용을 입력해주세요:(</span></div>
                  </div>
                </div>

                <!-- 게시글 첨부파일 등록 -->
                <div class="input_wrap register_bottom_wrap">
                  <div class="board_div">
                    <label for="board_title">파일첨부</label>
                    <div class="board_span">
                      <div class="file_wrap">
                        <div class="file_item other_file_item" th:each="attach:*{attaches}">
                          <label for="" class="file_item_label"></label>
                          <div class="">
                            <span th:text="${attach.originalName}"> </span>
                            <button type="button" class="btn-remove btn-file-remove" th:value="${attach.getFileName()}">- 제거</button>
                            <span class="size_limit_msg"><i class="fas fa-exclamation-circle"></i>(업로드 허용용량은 100MB입니다)</span>
                          </div>
                        </div>
                      </div>
                      <div class="file_wrap add_list">
                        <div class="file_item">
                          <label for="" class="file_item_label"></label>
                          <div class="">
                            <input type="file" class="board_file" name="file" />
                            <button type="button" class="btn-add btn-basic">+ 추가</button>
                            <span class="size_limit_msg"><i class="fas fa-exclamation-circle"></i>(업로드 허용용량은 100MB입니다)</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>


                <!-- 취소 & 등록 버튼 -->
                <div class="input_wrap">
                  <div class="board_div btn_wrap">
                  										<span>
                  											<button type="button" class="btn btn-basic cancel_btn" onclick="history.back()">취소</button>
                  										</span>
                    <span>
                  											<button type="button" class="btn btn-support insert_btn"
                                                onclick="document.getElementById('frm_board').submit();"
                                        >수정</button>
                  										</span>

                  </div>

                </div>

              </form>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
  <script>
    window.onload = function () {
      let fileCount = $('.file_item').length;
      let file_item = document.getElementsByClassName('file_item_label');
      let file_remove = document.getElementsByClassName('btn-file-remove');
      console.log(fileCount, file_item);
      for (let i = 1; i <= fileCount; i++) {
        file_item[i - 1].innerText = '첨부파일#' + i;
        if (i < fileCount) {
          file_remove[i - 1].setAttribute('data-num', i);
        }
      }
    };


    $('.btn-add').click(function () {
      var filecnt = $('.file_item').length;
      var html = '<div class="file_item other_file_item">' +
          '<label for="">첨부파일#' + (filecnt + 1) + '</label>' +
          '<div class="">' +
          '<input type="file" class="board_file" name="file" />' +
          '<button type="button" class="btn-remove" data-num="' + (filecnt + 1) + '">- 제거</button>' +
          '<span class="size_limit_msg"><i class="fas fa-exclamation-circle"></i>(업로드 허용용량은 100MB입니다)</span>' +
          '</div>' +
          '</div>';
      $('.add_list').append(html);
    });

    $(document).on('click', '.btn-remove', function () {
      var num = $(this).attr('data-num');
      $('.file_item').eq(num - 1).css('border', 'none').empty();
    });
    $(document).on('click', '.btn-file-remove', function () {
      var num = $(this).attr('data-num');
      $('.file_item').eq(num - 1).css('border', 'none').empty();
      const fileName = $(this).attr('value');
      console.log(fileName);
      $.ajax({
        url: '/api/' + fileName + '/delete',
        type: 'GET'
      }).done(function () {
        alert('Success');
      }).fail(function () {
        alert('error');
      });


    });
    $(document).on('change', '.board_file', function () {
      const file = $(this).val().toString();
      console.log(file);
      if (file.includes('[') || file.includes(']')) {
        alert('파일명에 대괄호는 포함할 수 없습니다.');
        $('.board_file').val('');
      }
    });



  </script>
</th:block>